import { Component, OnInit, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { AuthService } from '../../../../../core/services/rol/auth.service';
import { Doctor } from '../../../../../core/models/users/doctor';

// üìä Interfaces para Dashboard Doctor
interface EstadisticaGeneral {
  citasHoy: number;
  citasSemana: number;
  citasMes: number;
  totalPacientes: number;
  pacientesNuevos: number;
  citasPendientes: number;
  citasCompletadas: number;
  horasConsulta: number;
  eficiencia: number;
}

interface CitaResumen {
  id: number;
  hora: string;
  paciente: string;
  tipo: string;
  estado: 'siguiente' | 'programada' | 'completada';
  duracion: number;
}

interface PacienteReciente {
  id: number;
  nombre: string;
  ultimaCita: string;
  proximaCita?: string;
  estado: 'critico' | 'seguimiento' | 'control' | 'nuevo';
  diagnostico: string;
}

interface ActividadReciente {
  id: number;
  tipo: 'cita' | 'diagnostico' | 'tratamiento' | 'nota';
  descripcion: string;
  paciente: string;
  fecha: string;
  hora: string;
}
@Component({
  selector: 'app-resumen',
  standalone: true,
  imports: [CommonModule, RouterModule],
  templateUrl: './resumen.component.html',
  styleUrl: './resumen.component.css'
})
export class ResumenComponent implements OnInit {
  private authService = inject(AuthService);
  
  // üë®‚Äç‚öïÔ∏è Doctor actual
  doctorActual: Doctor | null = null;
  
  // üìä Estad√≠sticas generales
  estadisticas: EstadisticaGeneral = {
    citasHoy: 0,
    citasSemana: 0,
    citasMes: 0,
    totalPacientes: 0,
    pacientesNuevos: 0,
    citasPendientes: 0,
    citasCompletadas: 0,
    horasConsulta: 0,
    eficiencia: 0
  };
  
  // üìÖ Citas del d√≠a
  citasHoy: CitaResumen[] = [];
  proximaCita: CitaResumen | null = null;
  
  // üë• Pacientes recientes
  pacientesRecientes: PacienteReciente[] = [];
  
  // üìÑ Actividades recientes
  actividadesRecientes: ActividadReciente[] = [];
  
  // üï∞Ô∏è Fecha y hora actual
  fechaActual = new Date();
  horaActual = '';
  
  // üèÜ M√©tricas de rendimiento
  metricasRendimiento = {
    puntualidad: 95,
    satisfaccionPacientes: 98,
    tiempoPromedioCita: 32,
    derivacionesEfectivas: 87
  };

  ngOnInit(): void {
    this.obtenerDoctorActual();
    this.actualizarHora();
    this.cargarEstadisticas();
    this.cargarCitasHoy();
    this.cargarPacientesRecientes();
    this.cargarActividadesRecientes();
    
    // Actualizar hora cada minuto
    setInterval(() => this.actualizarHora(), 60000);
  }
  
  // üë®‚Äç‚öïÔ∏è Obtener doctor logueado
  private obtenerDoctorActual(): void {
    this.authService.authState$.subscribe(authState => {
      if (authState.isLoggedIn && authState.user?.rol === 'doctor') {
        this.doctorActual = authState.user as Doctor;
        console.log('üë®‚Äç‚öïÔ∏è Doctor en resumen:', this.doctorActual);
      }
    });
  }
  
  // üï∞Ô∏è Actualizar hora actual
  private actualizarHora(): void {
    this.fechaActual = new Date();
    this.horaActual = this.fechaActual.toLocaleTimeString('es-ES', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // üìä Cargar estad√≠sticas generales
  private cargarEstadisticas(): void {
    // Simular datos basados en la especialidad del doctor
    const especialidad = this.doctorActual?.especialidad || 'Medicina General';
    
    this.estadisticas = {
      citasHoy: this.generarCitasDelDia(especialidad),
      citasSemana: 28,
      citasMes: 115,
      totalPacientes: this.calcularPacientesPorEspecialidad(especialidad),
      pacientesNuevos: 12,
      citasPendientes: 8,
      citasCompletadas: 4,
      horasConsulta: 6.5,
      eficiencia: 94
    };
  }
  
  // üìÖ Cargar citas del d√≠a
  private cargarCitasHoy(): void {
    const especialidad = this.doctorActual?.especialidad || 'Medicina General';
    
    this.citasHoy = [
      {
        id: 1,
        hora: '08:00',
        paciente: 'Mar√≠a Garc√≠a L.',
        tipo: this.obtenerTipoConsultaPorEspecialidad(especialidad),
        estado: 'completada',
        duracion: 30
      },
      {
        id: 2,
        hora: '08:30',
        paciente: 'Carlos Rodr√≠guez M.',
        tipo: this.obtenerTipoConsultaPorEspecialidad(especialidad),
        estado: 'completada',
        duracion: 45
      },
      {
        id: 3,
        hora: '09:15',
        paciente: 'Ana Mart√≠nez S.',
        tipo: this.obtenerTipoConsultaPorEspecialidad(especialidad),
        estado: 'siguiente',
        duracion: 30
      },
      {
        id: 4,
        hora: '10:00',
        paciente: 'Luis Fern√°ndez C.',
        tipo: this.obtenerTipoConsultaPorEspecialidad(especialidad),
        estado: 'programada',
        duracion: 30
      },
      {
        id: 5,
        hora: '10:30',
        paciente: 'Patricia Jim√©nez V.',
        tipo: this.obtenerTipoConsultaPorEspecialidad(especialidad),
        estado: 'programada',
        duracion: 60
      }
    ];
    
    // Encontrar pr√≥xima cita
    this.proximaCita = this.citasHoy.find(cita => cita.estado === 'siguiente') || null;
  }
  
  // üë• Cargar pacientes recientes
  private cargarPacientesRecientes(): void {
    const especialidad = this.doctorActual?.especialidad || 'Medicina General';
    
    this.pacientesRecientes = [
      {
        id: 1,
        nombre: 'Roberto S√°nchez T.',
        ultimaCita: '2025-09-29',
        proximaCita: '2025-10-15',
        estado: 'seguimiento',
        diagnostico: this.obtenerDiagnosticoPorEspecialidad(especialidad)
      },
      {
        id: 2,
        nombre: 'Carmen Delgado R.',
        ultimaCita: '2025-09-28',
        estado: 'control',
        diagnostico: this.obtenerDiagnosticoPorEspecialidad(especialidad)
      },
      {
        id: 3,
        nombre: 'Javier Morales D.',
        ultimaCita: '2025-09-27',
        proximaCita: '2025-10-10',
        estado: 'critico',
        diagnostico: this.obtenerDiagnosticoPorEspecialidad(especialidad)
      },
      {
        id: 4,
        nombre: 'Isabella Torres M.',
        ultimaCita: '2025-09-30',
        estado: 'nuevo',
        diagnostico: 'Primera consulta'
      }
    ];
  }
  
  // üìÑ Cargar actividades recientes
  private cargarActividadesRecientes(): void {
    this.actividadesRecientes = [
      {
        id: 1,
        tipo: 'cita',
        descripcion: 'Cita completada con seguimiento',
        paciente: 'Mar√≠a Garc√≠a L.',
        fecha: '2025-09-30',
        hora: '08:00'
      },
      {
        id: 2,
        tipo: 'diagnostico',
        descripcion: 'Diagn√≥stico actualizado',
        paciente: 'Carlos Rodr√≠guez M.',
        fecha: '2025-09-30',
        hora: '08:30'
      },
      {
        id: 3,
        tipo: 'tratamiento',
        descripcion: 'Plan de tratamiento modificado',
        paciente: 'Ana Mart√≠nez S.',
        fecha: '2025-09-29',
        hora: '16:45'
      },
      {
        id: 4,
        tipo: 'nota',
        descripcion: 'Nota m√©dica agregada',
        paciente: 'Luis Fern√°ndez C.',
        fecha: '2025-09-29',
        hora: '14:20'
      }
    ];
  }
  
  // üèÖ M√©todos auxiliares para especialidades
  private generarCitasDelDia(especialidad: string): number {
    const citasPorEspecialidad: { [key: string]: number } = {
      'Cardiolog√≠a': 8,
      'Medicina General': 12,
      'Pediatr√≠a': 15,
      'Dermatolog√≠a': 10,
      'Neurolog√≠a': 6
    };
    return citasPorEspecialidad[especialidad] || 10;
  }
  
  private calcularPacientesPorEspecialidad(especialidad: string): number {
    const pacientesPorEspecialidad: { [key: string]: number } = {
      'Cardiolog√≠a': 245,
      'Medicina General': 380,
      'Pediatr√≠a': 420,
      'Dermatolog√≠a': 180,
      'Neurolog√≠a': 125
    };
    return pacientesPorEspecialidad[especialidad] || 200;
  }
  
  private obtenerTipoConsultaPorEspecialidad(especialidad: string): string {
    const tiposPorEspecialidad: { [key: string]: string[] } = {
      'Cardiolog√≠a': ['Control Cardiol√≥gico', 'Electrocardiograma', 'Ecocardiograma', 'Consulta Urgente'],
      'Medicina General': ['Consulta General', 'Control de Cronic√≥s', 'Chequeo Preventivo', 'Consulta Aguda'],
      'Pediatr√≠a': ['Control Ni√±o Sano', 'Vacunaci√≥n', 'Consulta Pedi√°trica', 'Urgencia Pedi√°trica'],
      'Dermatolog√≠a': ['Consulta Dermatol√≥gica', 'Control de Lunares', 'Tratamiento Acn√©', 'Dermatoscopia'],
      'Neurolog√≠a': ['Consulta Neurol√≥gica', 'Control Epilepsia', 'Evaluaci√≥n Cognitiva', 'Electroencefalograma']
    };
    const tipos = tiposPorEspecialidad[especialidad] || ['Consulta General'];
    return tipos[Math.floor(Math.random() * tipos.length)];
  }
  
  private obtenerDiagnosticoPorEspecialidad(especialidad: string): string {
    const diagnosticosPorEspecialidad: { [key: string]: string[] } = {
      'Cardiolog√≠a': ['Hipertensi√≥n Arterial', 'Arritmia Card√≠aca', 'Insuficiencia Card√≠aca', 'Angina de Pecho'],
      'Medicina General': ['Diabetes Mellitus', 'Hipertensi√≥n', 'Dislipidemia', 'S√≠ndrome Metab√≥lico'],
      'Pediatr√≠a': ['Desarrollo Normal', 'Infecci√≥n Respiratoria', 'Gastroenteritis', 'Alergia Alimentaria'],
      'Dermatolog√≠a': ['Dermatitis At√≥pica', 'Acn√© Vulgar', 'Psoriasis', 'Melanoma'],
      'Neurolog√≠a': ['Migra√±a', 'Epilepsia', 'Neuropat√≠a', 'Esclerosis M√∫ltiple']
    };
    const diagnosticos = diagnosticosPorEspecialidad[especialidad] || ['Diagn√≥stico General'];
    return diagnosticos[Math.floor(Math.random() * diagnosticos.length)];
  }
  
  // üöÄ Acciones r√°pidas
  iniciarSiguienteCita(): void {
    if (this.proximaCita) {
      alert(`Iniciando cita con ${this.proximaCita.paciente} a las ${this.proximaCita.hora}`);
    } else {
      alert('No hay pr√≥xima cita programada');
    }
  }
  
  verTodasLasCitas(): void {
    // Navegar al componente de citas
    console.log('Navegando a todas las citas...');
  }
  
  verTodosLosPacientes(): void {
    // Navegar al componente de pacientes
    console.log('Navegando a todos los pacientes...');
  }
  
  // üìÖ Utilidades de fecha
  obtenerFechaFormateada(): string {
    return this.fechaActual.toLocaleDateString('es-ES', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  obtenerSaludoSegunHora(): string {
    const hora = this.fechaActual.getHours();
    if (hora < 12) return 'Buenos d√≠as';
    if (hora < 18) return 'Buenas tardes';
    return 'Buenas noches';
  }
}
